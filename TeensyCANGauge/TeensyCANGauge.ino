/*
* Teensy CAN Gauge
* K.Nason
* 7/29/21
* 
* Useful Examples / Borrowed from:
* https://github.com/Arthris/MSCan_Gauge
* FlexCAN Library
* Adafruit SSD1306 Library
* 
* rusEFI CAN Broadcast
* https://github.com/rusefi/rusefi/blob/2ce77778653348a91cc579e3cb6b5df243e2e969/firmware/controllers/can/can_verbose.cpp
* 
* SETUP NOTES
* Setup the CAN base ID and can rate to match the CAN broadcast in Tuner Studio. Found in CAN settings.
* If using a Teensy 4.0 adjust commented lines in CAN settings. Teensy 3.x and 4.x use different pinouts
* If using I2C for the display adjust commented lines in display settings
* 
* 
*/


// Libraries
//=================================================================================================================================

#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

//Variables / Pins
//================================================================================================================================

// Input button pin
#define btnPin  16
// Total number of gaugels to be cycled
#define lastGauge  5

float sensorValue = 0;
int b = 0;
int g = 0;

// CAN Settings
// =================================================================================================================================

// Setup base ID and rate based on CAN settings
const int baseID = 1520;
const int canRate = 500000;

// Use this for Teensy 3.2
#include <FlexCAN.h> 
FlexCAN CANbus(canRate);

// Use this for Teensy 4.0
//#include <FlexCAN_T4.h> 
//FlexCAN_T4<CAN1, RX_SIZE_256, TX_SIZE_16> Can0;

void setupCAN(){
// Use for Teensy 4.0
// Can0.begin();  
// Can0.setBaudRate(canRate);

 // Use for Teensy 3.2
  Can0.begin(canRate); 
}

// Display Settings
//==================================================================================================================================

#define SCREEN_WIDTH 128 
#define SCREEN_HEIGHT 64 

#define OLED_DC     9
#define OLED_CS     10
#define OLED_RESET  15
#define SCREEN_ADDRESS 0x3C ///< See datasheet for Address; 0x3D for 128x64, 0x3C for 128x32

// SPI
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT,
  &SPI, OLED_DC, OLED_RESET, OLED_CS);

// I2C
//Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

//Splash Screen
// ==============================================================================================================================

const unsigned char rusEFI_splash[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xFF, 0xFF, 0xC1, 0xFF, 0xFF, 0xF1, 0xF0,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF, 0xF3, 0xF0,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x46, 0x00, 0x00, 0x13, 0x10,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x46, 0x00, 0x00, 0x13, 0x10,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x46, 0x00, 0x00, 0x13, 0x10,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0xFF, 0xFF, 0xC6, 0x7F, 0xFF, 0xF3, 0x10,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x00, 0xFF, 0xF3, 0xE0, 0x03, 0xE0, 0x7F, 0xFC, 0x11, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x03, 0xFF, 0xF3, 0xE0, 0x03, 0xE0, 0xFF, 0xFE, 0x11, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x07, 0xFF, 0xF3, 0xE0, 0x03, 0xE1, 0xFF, 0xFE, 0x11, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x0F, 0xFF, 0xF3, 0xE0, 0x03, 0xE3, 0xFF, 0xFE, 0x11, 0xFF, 0xFE, 0x06, 0x7F, 0xFF, 0x83, 0x10,
0x0F, 0xFF, 0xF3, 0xE0, 0x03, 0xE3, 0xFF, 0xFE, 0x11, 0xFF, 0xFF, 0x06, 0x7F, 0xFF, 0xC3, 0x10,
0x0F, 0xC0, 0x03, 0xE0, 0x03, 0xE3, 0xE0, 0x00, 0x10, 0x00, 0x03, 0x06, 0x00, 0x00, 0xC3, 0x10,
0x0F, 0x80, 0x03, 0xE0, 0x03, 0xE3, 0xFF, 0xF8, 0x10, 0x00, 0x03, 0x06, 0x00, 0x00, 0xC3, 0x10,
0x0F, 0x80, 0x03, 0xE0, 0x03, 0xE3, 0xFF, 0xFC, 0x10, 0x00, 0x03, 0x06, 0x00, 0x00, 0xC3, 0x10,
0x0F, 0x80, 0x03, 0xE0, 0x03, 0xE3, 0xFF, 0xFE, 0x11, 0xFF, 0xFF, 0x06, 0x7F, 0xFF, 0xC3, 0x10,
0x0F, 0x80, 0x03, 0xE0, 0x03, 0xE1, 0xFF, 0xFF, 0x11, 0xFF, 0xE0, 0x06, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x03, 0xE0, 0x03, 0xE0, 0xFF, 0xFF, 0x11, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x03, 0xE0, 0x03, 0xE0, 0x00, 0x1F, 0x91, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x03, 0xF0, 0x03, 0xE0, 0x00, 0x1F, 0x91, 0x80, 0x00, 0x06, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x03, 0xF8, 0x03, 0xE0, 0x00, 0x1F, 0x99, 0xFF, 0xFF, 0xC6, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x01, 0xFF, 0xFF, 0xE3, 0xFF, 0xFF, 0x98, 0xFF, 0xFF, 0xC6, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x01, 0xFF, 0xFF, 0xE3, 0xFF, 0xFF, 0x08, 0x00, 0x00, 0x46, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x00, 0xFF, 0xFF, 0xE3, 0xFF, 0xFF, 0x0C, 0x00, 0x00, 0x46, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x00, 0x7F, 0xFF, 0xE3, 0xFF, 0xFE, 0x07, 0x00, 0x00, 0x44, 0x60, 0x00, 0x03, 0x10,
0x0F, 0x80, 0x00, 0x1F, 0xFF, 0xC3, 0xFF, 0xF8, 0x03, 0xFF, 0xFF, 0xC7, 0xE0, 0x00, 0x03, 0xF0,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Setup CAN Sensor Channels
// =================================================================================================================================

struct DATA {
  String chName;
  int address;
  int sByte;
  int sBit;
  int len;
  float scale;
  String unit;
  float val;
};


  // Base ID + 0
  DATA warningCount = {"Warning Counter",0,0,0,16,1,"#"};
  DATA lastError =  {"Last Error Code",0,2,0,16,1,"#"};
  DATA revLimit =  {"Rev Limit Active",0,4,0,1,1,"On"};
  DATA mainRelay =  {"Main Relay Active",0,4,1,1,1,"On"};
  DATA fuelPump =  {"Fuel Pump Active",0,4,2,1,1,"On"};
  DATA checkEngine = {"Check Engine Active",0,4,3,1,1,"On"};

  // Base ID + 1  
  DATA rpm = {"RPM",1,0,0,16,1,""};
  DATA timing =  {"Timing",1,2,0,16,0.02,"deg"};
  DATA injDuty =  {"Injector Duty",1,4,0,16,0.5,"%"};
  DATA vSpeed =  {"Speed",1,6,0,8,1,"kph"};

  // Base ID + 2
  DATA accelPos = {"Accel Position",2,0,0,16,0.01,"%"};
  DATA tps1 ={"TPS 1",2,2,0,16,0.01,"%"};
  DATA tps2 = {"TPS 2",2,4,0,16,0.01,"%"};

  // Base ID + 3
  DATA mapP ={"MAP",3,0,0,16,0.03,"kPa"};
  DATA clt = {"Coolant",3,2,0,8,1,"C"};
  DATA iat = {"Intake",3,3,0,8,1,"C"};
  DATA aux1 = {"Aux 1",3,4,0,8,1,"C"};
  DATA aux2 = {"Aux 2",3,5,0,8,1,"C"};
  DATA mcu = {"MCU",3,5,0,8,1,"C"};
  DATA fuel ={"Fuel",3,6,0,8,0.5,"%"};
  
  // Base ID + 4
  DATA afr = {"AFR",4,0,0,16,0.001,""};
  DATA oil = {"Oil",4,2,0,16,0.03,"kPa"};
  DATA vvt = {"VVT",4,4,0,16,0.02,"deg"};
  DATA battery = {"Battery",4,6,0,16,0.001,"V"};

  // Base ID + 5
  DATA airMass = {"Air Mass",5,0,0,16,1,"mg"};
  DATA airFlow = {"Air Flow",5,2,0,16,0.01,"kg/h"};
  DATA injPw = {"Inj Pw",5,4,0,16,0.003,"ms"};

// Functions
// ================================================================================================================================================

 // Check the message ID and update sensor values contained in the message
void setupSensorData(CAN_message_t inMsg){
  switch (inMsg.id){

      case (baseID + 1):
        rpm.val = getSensorData2(inMsg,rpm);
        timing.val = getSensorData2(inMsg,timing);
        injDuty.val = getSensorData2(inMsg,injDuty);
        vSpeed.val = getSensorData2(inMsg,vSpeed);
        break;
        
      case (baseID + 2):
        accelPos.val = getSensorData2(inMsg,accelPos);
        tps1.val = getSensorData2(inMsg,tps1);
        tps2.val = getSensorData2(inMsg,tps2);
        break;
        
      case (baseID + 3):
         mapP.val = getSensorData2(inMsg,mapP);
         clt.val = getSensorData2(inMsg,clt);
         iat.val = getSensorData2(inMsg,iat);
         aux1.val = getSensorData2(inMsg,aux1);
         aux2.val = getSensorData2(inMsg,aux2);
         mcu.val = getSensorData2(inMsg,mcu);
         fuel.val = getSensorData2(inMsg,fuel);
        break;
        
      case (baseID + 4):
          afr.val = getSensorData2(inMsg,afr);
          oil.val = getSensorData2(inMsg,oil);
         vvt.val = getSensorData2(inMsg,vvt);
          battery.val = getSensorData2(inMsg,battery);
        break;
        
      case (baseID + 5):
          airMass.val = getSensorData2(inMsg,airMass);
          airFlow.val = getSensorData2(inMsg,airFlow);
          injPw.val = getSensorData2(inMsg,injPw);
        break;
    }  
}

void buttonPress(){
  b = 1;
}

// Print text of a defined size and location in pixels
void printText(String text, int textSize, int locX, int locY){
  display.setTextSize(textSize);         
  display.setTextColor(SSD1306_WHITE);    
  display.setCursor(locX,locY);          
  display.println((text));                                 
}


void showSplash(){
  display.clearDisplay();
  display.drawBitmap(0,0, rusEFI_splash, 128, 64, 1);
  display.display();
}

// Display the CAN rate in kbps and Base ID setting
void showSettings(){
  display.clearDisplay();
  printText("CAN",2,0,0);
  printText("rate " + String(canRate/1000) + "k",2,0,20);
  printText("base " + String(baseID),2,0,40);
  display.display();
}
// Sets up a single sensor value for the display, still requires updating the display
void printSensor1(struct DATA &channel){  
    printText(channel.chName + " " + channel.unit,1,0,0);
    printText(String(channel.val),3,0,35);     
}

// Sets up two sensor values for the display, still requires updating the display
void printSensor2(struct DATA &channel, struct DATA &channel2){
    printText(channel.chName + " " + channel.unit,1,0,0);
    printText(String(channel.val),3,45,8); 
    printText(channel2.chName + " " + channel2.unit,1,0,36);
    printText(String(channel2.val),3,45,44); 
}


float getSensorData2(CAN_message_t CANmsg, struct DATA &channel){

  // Check the data length in bits (1 to 2 bytes) and grab that many from the starting byte location
  if (channel.len == 8){
    channel.val = (int)CANmsg.buf[channel.sByte];  
  }
  else if (channel.len == 16){
    sensorValue = (int)(word(CANmsg.buf[channel.sByte+1],CANmsg.buf[channel.sByte])); 
  }
  else {
    sensorValue = 0;
  }

  // Apply data scaling
  sensorValue = sensorValue * channel.scale;
  return sensorValue;
}


// MAIN
//==================================================================================================================================


void setup(){
  //Serial.begin(9600);
  // Setup interrupt for input button, setup to use a normally open button to pull input pin low on press
  pinMode(btnPin, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(btnPin),buttonPress,LOW);

  
  setupCAN();
  
  // Start the display
  if(!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
   for(;;);
  }

  showSplash();
  delay(2500);

  showSettings();
  delay(2500);

// print message to the display, it will remain until data is recieved
  display.clearDisplay();
  printText((" Waiting   for Data     ..."),2,0,10);
  display.display();
  
}

void loop(){
  CAN_message_t inMsg;

 // Only update the display when a CAN message is recieved 
  if ( Can0.available() ) {
    Can0.read(inMsg);
  // Update values contained in the reieved message
    setupSensorData(inMsg);
  
   // Update the display with the selected sensor value
    switch (g){
    case 0:
      printSensor1(afr);
      break;
    case 1:
      printSensor1(rpm);
      break;
    case 2:
      printSensor2(clt,iat);
      break;
    case 3:
      printSensor2(iat,mapP);
      break;
    case 4:
      printSensor2(rpm,afr);
      break;
    case 5:
      printSensor1(battery);
      break;
    }
    
    display.display();
    display.clearDisplay();
  }

    // Cycle to the next gauge/sensor if the button was pressed
    if (b==1){
      b=0;
      g++;
      if (g>lastGauge){
        g=0;
       }
    }
}
